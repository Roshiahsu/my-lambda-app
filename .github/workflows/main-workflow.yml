name: Main Workflow

on:
  push:
    branches:
      - yml-test

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: AWS
    permissions:
      id-token: write
      contents: read
    env:
      BUILD_TYPE: ${{ vars.BUILD_TYPE || github.event.inputs.build-type || 's3' }}
      NAME: yml-test
    steps:
      - name: Debug Variables
        run: |
          echo "BUILD_TYPE: ${{ env.BUILD_TYPE }}"

      - name: Set BUILD_TYPE Output
        id: set-output
        run: |
          echo "build_type=${{ vars.BUILD_TYPE || 's3' }}" >> "$GITHUB_OUTPUT"

  call-build-docker:
    needs: deploy
    if: ${{ needs.deploy.outputs.build_type == 'docker' }}
    uses: ./.github/workflows/build-docker.yml
    with:
      aws-region: ${{ vars.AWS_REGION }}
      ecr-repo: ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.ap-northeast-3.amazonaws.com/my-lambda-image
    secrets:
      aws-account-id: ${{ secrets.AWS_ACCOUNT_ID }}

  call-build-s3:
    needs: deploy
    if: ${{ needs.deploy.outputs.build_type == 's3' }}
    uses: ./.github/workflows/build-s3.yml
    with:
      aws-region: ${{ vars.AWS_REGION }}
      branch_name: yml-test

#  deploy-lambda:
#    runs-on: ubuntu-latest
#    environment: AWS
#    permissions:
#      id-token: write
#      contents: read
#    needs: deploy
#    if: ${{ vars.UPDATE_LAMBDA == 'true' }}
#    env:
#      BUILD_TYPE: ${{ vars.BUILD_TYPE || github.event.inputs.build-type || 'docker' }}
#      ECR_REPO: ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.ap-northeast-3.amazonaws.com/my-lambda-image
#      S3_BUCKET: ${{ vars.AWS_S3_BUCKET_JAR || 'lambda-deploy-jar-roshia' }}
#    steps:
#      - name: Configure AWS credentials via OIDC
#        uses: aws-actions/configure-aws-credentials@v2
#        with:
#          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/github-pipeline
#          aws-region: ${{ vars.AWS_REGION || 'ap-northeast-3' }}
#
#      - name: Deploy to Lambda
#        run: |
#          if [ "${{ env.BUILD_TYPE }}" == "docker" ]; then
#            IMAGE_URI="${{ env.ECR_REPO }}:latest"
#            aws lambda update-function-code --function-name github_pipeline_docker_Img --image-uri $IMAGE_URI
#          else
#            aws lambda update-function-code --function-name github_pipeline_docker_Img --s3-bucket ${{ env.S3_BUCKET }} --s3-key my-lambda.jar
#          fi
#          if [ $? -ne 0 ]; then
#            echo "Lambda deployment failed"
#            exit 1
#          fi